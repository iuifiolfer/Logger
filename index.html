<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diario de entro - Fet per un Friki</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .exercise-item {
            transition: all 0.3s ease;
        }
        .exercise-item.dragging {
            opacity: 0.5;
            background-color: #f0f0f0;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<!-- Hauria de treurem la mania de fer el code en ingles i dsp el text en catala, també m'excuso perque tenia pensat fer-ho 100% en ingles-->
<!-- I també hauria de treure la mania de escriure els comentaris aquests innecesaris xdd-->
<body class="bg-stone-300 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div id="welcome-screen" class="text-center">
            <h1 class="text-3xl font-bold text-stone-900 mb-10">Diari Entreno</h1>
            <p class="text-lg text-gray-600 mb-20">Si, sóc un friki i m'he fet una aplicacio per a logear els entrenos.</p>
            
            <div class="flex flex-col md:flex-row justify-center gap-14 mb-12">
                <button onclick="showCreateRoutineForm()" class="bg-gray-600 hover:bg-gray-700 text-gray-100 font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 flex items-center justify-center gap-2">
                    <i class="fas fa-plus"></i>
                </button>
                <button onclick="showMyRoutines()" class="bg-gray-100 hover:bg-gray-100 text-gray-600 font-semibold py-3 px-6 rounded-lg border border-gray-600 shadow-sm transition duration-300 flex items-center justify-center gap-2">
                    <i class="fas fa-dumbbell"></i>
                </button>
            </div>
        </div>
        <div id="create-routine-form" class="hidden max-w-2xl mx-auto bg-gray-100 p-6 rounded-lg shadow-md">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-800">Crear Dia de Nou Split</h2>
                <button onclick="showWelcomeScreen()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="routine-form" class="space-y-4">
                <div>
                    <label for="routine-name" class="block text-sm font-medium text-gray-700 mb-1">Nom del Entreno</label>
                    <input type="text" id="routine-name" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-gray-500 focus:border-gray-500">
                </div>
                
                <div>
                    <label for="routine-description" class="block text-sm font-medium text-gray-700 mb-1">Descripcio (Posa-ho si vols)</label>
                    <textarea id="routine-description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-gray-500 focus:border-gray-500"></textarea>
                </div>
                
                <div>
                    <label for="routine-image" class="block text-sm font-medium text-gray-700 mb-1">Imatge (També si vols)</label>
                    <input type="file" id="routine-image" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-gray-50 file:text-gray-700 hover:file:bg-gray-100">
                </div>
                
                <div class="pt-4">
                    <button type="button" onclick="addExercise()" class="bg-gray-600 hover:bg-gray-700 text-gray-100 font-semibold py-2 px-4 rounded-md shadow-sm transition duration-300 flex items-center gap-2">
                        <i class="fas fa-plus"></i> Afegir Exercici
                    </button>
                </div>
                
                <div id="exercises-container" class="space-y-3 mt-4">
                </div>
                
                <div class="flex justify-end gap-3 pt-6">
                    <button type="button" onclick="showWelcomeScreen()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 bg-gray-100 hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="button" onclick="saveRoutine()" class="px-4 py-2 bg-gray-600 text-gray-100 rounded-md hover:bg-gray-700">
                        Guardar Entreno
                    </button>
                </div>
            </form>
        </div>

        <div id="my-routines-screen" class="hidden">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-semibold text-gray-800">Llista d'Entrenos</h2>
                <button onclick="showWelcomeScreen()" class="text-gray-600 hover:text-gray-800 flex items-center gap-1">
                    <i class="fas fa-arrow-left"></i> Enrere
                </button>
            </div>
            
            <div class="mb-6 relative">
                <input type="text" id="routine-search" placeholder="Buscar entrenos..." class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-md focus:ring-gray-500 focus:border-gray-500">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
            </div>
            
            <div id="routines-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            </div>
        </div>

        <!-- Routine Detail Screen -->
        <div id="routine-detail-screen" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <button onclick="showMyRoutines()" class="text-gray-600 hover:text-gray-800 flex items-center gap-1">
                    <i class="fas fa-arrow-left"></i> Enrere
                </button>
                <div class="flex gap-2">
                    <button onclick="editCurrentRoutine()" class="text-gray-600 hover:text-gray-800 flex items-center gap-1">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button onclick="deleteCurrentRoutine()" class="text-red-600 hover:text-red-800 flex items-center gap-1">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            </div>
            
            <div id="routine-detail-content" class="bg-gray-100 rounded-lg shadow-md overflow-hidden">

            </div>
        </div>

        <!-- Edit Exercises Screen -->
        <div id="edit-exercises-screen" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <button onclick="showRoutineDetail()" class="text-gray-600 hover:text-gray-800 flex items-center gap-1">
                    <i class="fas fa-arrow-left"></i> Enrere
                </button>
                <button onclick="saveExerciseChanges()" class="bg-gray-600 hover:bg-gray-700 text-gray-100 font-semibold py-2 px-4 rounded-md shadow-sm transition duration-300">
                    Guardar Canvis
                </button>
            </div>
            
            <div class="bg-gray-100 rounded-lg shadow-md p-6">
                <h3 id="edit-exercises-title" class="text-xl font-semibold text-gray-800 mb-4">Editar Exercicis</h3>
                
                <button onclick="addExerciseInEditMode()" class="mb-4 bg-gray-600 hover:bg-gray-700 text-gray-100 font-semibold py-2 px-4 rounded-md shadow-sm transition duration-300 flex items-center gap-2">
                    <i class="fas fa-plus"></i> Afegir Exercici
                </button>
                
                <div id="edit-exercises-container" class="space-y-3 custom-scrollbar" style="max-height: 70vh; overflow-y: auto;">

                </div>
            </div>
        </div>

        <div id="log-workout-screen" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <button onclick="showRoutineDetail()" class="text-gray-600 hover:text-gray-800 flex items-center gap-1">
                    <i class="fas fa-arrow-left"></i> Enrere
                </button>
                <button onclick="saveWorkoutLog()" class="bg-gray-600 hover:bg-gray-700 text-gray-100 font-semibold py-2 px-4 rounded-md shadow-sm transition duration-300">
                    Guardar Entreno
                </button>
            </div>
            
            <div class="bg-gray-100 rounded-lg shadow-md p-6">
                <h3 id="log-workout-title" class="text-xl font-semibold text-gray-800 mb-2">Registrar Entreno</h3>
                <p class="text-gray-500 mb-4" id="log-workout-date"></p>
                
                <div id="log-workout-container" class="space-y-6 custom-scrollbar" style="max-height: 70vh; overflow-y: auto;">

                </div>
            </div>
        </div>

        <div id="workout-history-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-gray-100 rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-hidden flex flex-col">
                <div class="flex justify-between items-center border-b px-6 py-4">
                    <h3 class="text-lg font-semibold text-gray-800" id="history-modal-title">Diari d'Entrenos</h3>
                    <button onclick="closeHistoryModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="workout-history-content" class="p-6 overflow-y-auto custom-scrollbar flex-grow">

                </div>
                
                <div class="border-t px-6 py-3 bg-gray-50 flex justify-end">
                    <button onclick="closeHistoryModal()" class="px-4 py-2 bg-gray-600 text-gray-100 rounded-md hover:bg-gray-700">
                        Tancar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Ara ve la sudada, ChatGPT comes in handy lmao. Aver ajuda, pero procuro ferho jo, i si no ho entenc doncs ho entenc >:|
        let routines = JSON.parse(localStorage.getItem('workoutRoutines')) || [];
        let currentRoutineId = null;
        let currentExerciseId = 0;
        

        const welcomeScreen = document.getElementById('welcome-screen');
        const createRoutineForm = document.getElementById('create-routine-form');
        const myRoutinesScreen = document.getElementById('my-routines-screen');
        const routineDetailScreen = document.getElementById('routine-detail-screen');
        const editExercisesScreen = document.getElementById('edit-exercises-screen');
        const logWorkoutScreen = document.getElementById('log-workout-screen');
        const workoutHistoryModal = document.getElementById('workout-history-modal');
        
        // Com m'agraden les funcions xddd

        function showWelcomeScreen() {
            welcomeScreen.classList.remove('hidden');
            createRoutineForm.classList.add('hidden');
            myRoutinesScreen.classList.add('hidden');
            routineDetailScreen.classList.add('hidden');
            editExercisesScreen.classList.add('hidden');
            logWorkoutScreen.classList.add('hidden');
        }
        
        function showCreateRoutineForm() {
            welcomeScreen.classList.add('hidden');
            createRoutineForm.classList.remove('hidden');
            resetRoutineForm();
        }
        
        function showMyRoutines() {
            welcomeScreen.classList.add('hidden');
            myRoutinesScreen.classList.remove('hidden');
            loadRoutines();
        }
        
        function showRoutineDetail(routineId = null) {
            if (routineId) currentRoutineId = routineId;
            
            myRoutinesScreen.classList.add('hidden');
            routineDetailScreen.classList.remove('hidden');
            editExercisesScreen.classList.add('hidden');
            logWorkoutScreen.classList.add('hidden');
            
            loadRoutineDetail();
        }
        
        function showEditExercises() {
            routineDetailScreen.classList.add('hidden');
            editExercisesScreen.classList.remove('hidden');
            loadExercisesForEditing();
        }
        
        function showLogWorkout() {
            routineDetailScreen.classList.add('hidden');
            logWorkoutScreen.classList.remove('hidden');
            loadExercisesForLogging();
        }
        
        function openHistoryModal() {
            workoutHistoryModal.classList.remove('hidden');
            loadWorkoutHistory();
        }
        
        function closeHistoryModal() {
            workoutHistoryModal.classList.add('hidden');
        }
        
        function resetRoutineForm() {
            document.getElementById('routine-form').reset();
            document.getElementById('exercises-container').innerHTML = '';
            currentExerciseId = 0;
            currentRoutineId = null;
        }
        
        function addExercise() {
            currentExerciseId++;
            const exerciseId = `exercise-${currentExerciseId}`;
            
            const exerciseHTML = `
                <div id="${exerciseId}" class="exercise-item p-4 border border-gray-200 rounded-md bg-gray-50">
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="font-medium text-gray-800">Exercici ${currentExerciseId}</h4>
                        <button onclick="removeExercise('${exerciseId}')" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label for="${exerciseId}-name" class="block text-sm font-medium text-gray-700 mb-1">Nom del exercici</label>
                            <input type="text" id="${exerciseId}-name" required class="w-full px-3 py-1 border border-gray-300 rounded-md focus:ring-gray-500 focus:border-gray-500">
                        </div>
                        <div>
                            <label for="${exerciseId}-description" class="block text-sm font-medium text-gray-700 mb-1">Descripcio (Opcional)</label>
                            <textarea id="${exerciseId}-description" rows="2" class="w-full px-3 py-1 border border-gray-300 rounded-md focus:ring-gray-500 focus:border-gray-500"></textarea>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('exercises-container').insertAdjacentHTML('beforeend', exerciseHTML);
            setupExerciseDragAndDrop(exerciseId);
        }
        
        function removeExercise(exerciseId) {
            document.getElementById(exerciseId).remove();
        }
        
        function saveRoutine() {
            const routineName = document.getElementById('routine-name').value.trim();
            if (!routineName) {
                alert('Introdueix el nom de la routina.');
                return;
            }
            
            const routineDescription = document.getElementById('routine-description').value.trim();
            const routineImageInput = document.getElementById('routine-image');
            
            const exerciseElements = document.querySelectorAll('#exercises-container > div');
            if (exerciseElements.length === 0) {
                alert('Afegeix com a minim un exercici bro, sino no es un entreno');
                return;
            }
            
            const exercises = Array.from(exerciseElements).map(exerciseEl => {
                const id = exerciseEl.id;
                return {
                    id: id,
                    name: document.getElementById(`${id}-name`).value.trim(),
                    description: document.getElementById(`${id}-description`).value.trim(),
                    history: []
                };
            });
   
            const routine = {
                id: currentRoutineId || Date.now().toString(),
                name: routineName,
                description: routineDescription,
                image: null,
                exercises: exercises,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (routineImageInput.files.length > 0) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    routine.image = e.target.result;
                    saveRoutineToStorage(routine);
                };
                reader.readAsDataURL(routineImageInput.files[0]);
            } else {
                saveRoutineToStorage(routine);
            }
        }
        
        function saveRoutineToStorage(routine) {
            if (currentRoutineId) {
                const index = routines.findIndex(r => r.id === currentRoutineId);
                if (index !== -1) {
                    routines[index] = routine;
                }
            } else {
                routines.push(routine);
            }
            
            localStorage.setItem('workoutRoutines', JSON.stringify(routines));
            showMyRoutines();
        }

        function loadRoutines() {
            const routinesContainer = document.getElementById('routines-container');
            routinesContainer.innerHTML = '';
            
            if (routines.length === 0) {
                routinesContainer.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-dumbbell text-4xl text-gray-300 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-500">Encara no hi ha Entrenos!</h3>
                        <p class="text-gray-400 mt-2">Crea el primer entreno!!</p>
                        <button onclick="showCreateRoutineForm()" class="mt-4 bg-gray-600 hover:bg-gray-700 text-gray-100 font-semibold py-2 px-4 rounded-md shadow-sm transition duration-300">
                            Crear Entreno
                        </button>
                    </div>
                `;
                return;
            }
            
            routines.forEach(routine => {
                const routineCard = document.createElement('div');
                routineCard.className = 'bg-gray-100 rounded-lg shadow-md overflow-hidden hover:shadow-lg transition duration-300 cursor-pointer';
                routineCard.onclick = () => showRoutineDetail(routine.id);
                
                let imageHTML = '';
                if (routine.image) {
                    imageHTML = `<img src="${routine.image}" alt="${routine.name}" class="w-full h-40 object-cover">`;
                } else {
                    imageHTML = `
                        <div class="w-full h-40 bg-gray-100 flex items-center justify-center">
                            <i class="fas fa-dumbbell text-4xl text-gray-400"></i>
                        </div>
                    `;
                }
                
                routineCard.innerHTML = `
                    ${imageHTML}
                    <div class="p-4">
                        <div class="flex justify-between items-start">
                            <h3 class="text-lg font-semibold text-gray-800">${routine.name}</h3>
                            <span class="text-xs text-gray-500">${formatDate(routine.updatedAt)}</span>
                        </div>
                        ${routine.description ? `<p class="text-gray-600 text-sm mt-1">${routine.description}</p>` : ''}
                        <div class="flex justify-between items-center mt-3 text-sm">
                            <span class="text-gray-600">${routine.exercises.length} exercicis</span>
                            <button onclick="event.stopPropagation(); deleteRoutine('${routine.id}')" class="text-red-500 hover:text-red-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                routinesContainer.appendChild(routineCard);
            });
            
            document.getElementById('routine-search').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const cards = document.querySelectorAll('#routines-container > div');
                
                cards.forEach(card => {
                    const title = card.querySelector('h3').textContent.toLowerCase();
                    const description = card.querySelector('p') ? card.querySelector('p').textContent.toLowerCase() : '';
                    
                    if (title.includes(searchTerm) || description.includes(searchTerm)) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        }
        
        function loadRoutineDetail() {
            const routine = routines.find(r => r.id === currentRoutineId);
            if (!routine) {
                showMyRoutines();
                return;
            }
            
            const routineDetailContent = document.getElementById('routine-detail-content');
            
            let imageHTML = '';
            if (routine.image) {
                imageHTML = `<img src="${routine.image}" alt="${routine.name}" class="w-full h-48 object-cover">`;
            } else {
                imageHTML = `
                    <div class="w-full h-48 bg-gray-100 flex items-center justify-center">
                        <i class="fas fa-dumbbell text-6xl text-gray-400"></i>
                    </div>
                `;
            }
            
            const exercisesHTML = routine.exercises.map(exercise => `
                <div class="p-4 border-b border-gray-200 last:border-b-0">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-medium text-gray-800">${exercise.name}</h4>
                            ${exercise.description ? `<p class="text-gray-600 text-sm mt-1">${exercise.description}</p>` : ''}
                        </div>
                        <button onclick="logExercise('${exercise.id}')" class="text-gray-600 hover:text-gray-800 text-sm font-medium">
                            Logear Serie
                        </button>
                    </div>
                    ${exercise.history.length > 0 ? `
                        <div class="mt-2">
                            <p class="text-xs text-gray-500">Ultim loggeado: ${formatDate(exercise.history[exercise.history.length - 1].date)}</p>
                        </div>
                    ` : ''}
                </div>
            `).join('');
            
            routineDetailContent.innerHTML = `
                ${imageHTML}
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-2xl font-semibold text-gray-800">${routine.name}</h3>
                            ${routine.description ? `<p class="text-gray-600 mt-1">${routine.description}</p>` : ''}
                        </div>
                        <button onclick="showEditExercises()" class="text-gray-600 hover:text-gray-800 flex items-center gap-1">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                    
                    <div class="flex gap-3 mb-6">
                        <button onclick="showLogWorkout()" class="bg-gray-600 hover:bg-gray-700 text-gray-100 font-semibold py-2 px-4 rounded-md shadow-sm transition duration-300 flex items-center gap-2">
                            <i class="fas fa-plus-circle"></i> Registrar Entreno
                        </button>
                        <button onclick="openHistoryModal()" class="bg-gray-100 hover:bg-gray-100 text-gray-600 font-semibold py-2 px-4 rounded-md border border-gray-600 shadow-sm transition duration-300 flex items-center gap-2">
                            <i class="fas fa-history"></i> Veure el Diari
                        </button>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg border border-gray-200 overflow-hidden">
                        <div class="p-3 bg-gray-100 border-b border-gray-200">
                            <h4 class="font-medium text-gray-800">Exercicis</h4>
                        </div>
                        <div>
                            ${exercisesHTML}
                        </div>
                    </div>
                </div>
            `;
        }
     
        function loadExercisesForEditing() {
            const routine = routines.find(r => r.id === currentRoutineId);
            if (!routine) return;
            
            document.getElementById('edit-exercises-title').textContent = `Editar Exercicis per a ${routine.name}`;
            const container = document.getElementById('edit-exercises-container');
            container.innerHTML = '';
            
            routine.exercises.forEach((exercise, index) => {
                const exerciseHTML = `
                    <div id="edit-${exercise.id}" class="exercise-item p-4 border border-gray-200 rounded-md bg-gray-50 cursor-move">
                        <div class="flex justify-between items-start mb-3">
                            <h4 class="font-medium text-gray-800">Exercici ${index + 1}</h4>
                            <button onclick="removeExerciseInEditMode('${exercise.id}')" class="text-red-500 hover:text-red-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label for="edit-${exercise.id}-name" class="block text-sm font-medium text-gray-700 mb-1">Nom de l'exercici</label>
                                <input type="text" id="edit-${exercise.id}-name" value="${exercise.name}" required class="w-full px-3 py-1 border border-gray-300 rounded-md focus:ring-gray-500 focus:border-gray-500">
                            </div>
                            <div>
                                <label for="edit-${exercise.id}-description" class="block text-sm font-medium text-gray-700 mb-1">Description (Optional)</label>
                                <textarea id="edit-${exercise.id}-description" rows="2" class="w-full px-3 py-1 border border-gray-300 rounded-md focus:ring-gray-500 focus:border-gray-500">${exercise.description || ''}</textarea>
                            </div>
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', exerciseHTML);
                setupExerciseDragAndDrop(`edit-${exercise.id}`);
            });
   
            new Sortable(container, {
                animation: 150,
                ghostClass: 'dragging',
                onEnd: function() {

                }
            });
        }
        
        function addExerciseInEditMode() {
            const routine = routines.find(r => r.id === currentRoutineId);
            if (!routine) return;
            
            const newId = `new-exercise-${Date.now()}`;
            const newExercise = {
                id: newId,
                name: 'Nou Exercici',
                description: '',
                history: []
            };
            
            routine.exercises.push(newExercise);
            
            const container = document.getElementById('edit-exercises-container');
            const exerciseHTML = `
                <div id="edit-${newId}" class="exercise-item p-4 border border-gray-200 rounded-md bg-gray-50 cursor-move">
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="font-medium text-gray-800">Exercici ${routine.exercises.length}</h4>
                        <button onclick="removeExerciseInEditMode('${newId}')" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label for="edit-${newId}-name" class="block text-sm font-medium text-gray-700 mb-1">Nom de l'exercici</label>
                            <input type="text" id="edit-${newId}-name" value="Nou Exercici" required class="w-full px-3 py-1 border border-gray-300 rounded-md focus:ring-gray-500 focus:border-gray-500">
                        </div>
                        <div>
                            <label for="edit-${newId}-description" class="block text-sm font-medium text-gray-700 mb-1">Descripcio (Opcional)</label>
                            <textarea id="edit-${newId}-description" rows="2" class="w-full px-3 py-1 border border-gray-300 rounded-md focus:ring-gray-500 focus:border-gray-500"></textarea>
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', exerciseHTML);
            setupExerciseDragAndDrop(`edit-${newId}`);
        }
        
        function removeExerciseInEditMode(exerciseId) {
            const routine = routines.find(r => r.id === currentRoutineId);
            if (!routine) return;
            
            routine.exercises = routine.exercises.filter(ex => ex.id !== exerciseId);
            document.getElementById(`edit-${exerciseId}`).remove();
            
            const exerciseItems = document.querySelectorAll('#edit-exercises-container > div');
            exerciseItems.forEach((item, index) => {
                const title = item.querySelector('h4');
                if (title) {
                    title.textContent = `Exercici ${index + 1}`;
                }
            });
        }
        
        function saveExerciseChanges() {
            const routine = routines.find(r => r.id === currentRoutineId);
            if (!routine) return;
  
            routine.exercises.forEach(exercise => {
                const nameInput = document.getElementById(`edit-${exercise.id}-name`);
                const descriptionInput = document.getElementById(`edit-${exercise.id}-description`);
                
                if (nameInput && descriptionInput) {
                    exercise.name = nameInput.value.trim();
                    exercise.description = descriptionInput.value.trim();
                }
            });
 
            const container = document.getElementById('edit-exercises-container');
            const newOrder = Array.from(container.children).map(child => {
                return child.id.replace('edit-', '');
            });
            
            routine.exercises.sort((a, b) => {
                return newOrder.indexOf(a.id) - newOrder.indexOf(b.id);
            });
            
            routine.updatedAt = new Date().toISOString();
            localStorage.setItem('workoutRoutines', JSON.stringify(routines));
            showRoutineDetail();
        }
        
        function loadExercisesForLogging() {
            const routine = routines.find(r => r.id === currentRoutineId);
            if (!routine) return;
            
            document.getElementById('log-workout-title').textContent = `Registrar Entreno: ${routine.name}`;
            document.getElementById('log-workout-date').textContent = `Avui, ${formatDate(new Date().toISOString())}`;
            
            const container = document.getElementById('log-workout-container');
            container.innerHTML = '';
            
            routine.exercises.forEach(exercise => {
                const exerciseHTML = `
                    <div class="bg-gray-50 rounded-lg border border-gray-200 p-4">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="font-medium text-gray-800">${exercise.name}</h4>
                                ${exercise.description ? `<p class="text-gray-600 text-sm mt-1">${exercise.description}</p>` : ''}
                            </div>
                            <button onclick="addSet('${exercise.id}')" class="bg-gray-600 hover:bg-gray-700 text-gray-100 text-sm font-semibold py-1 px-3 rounded-md shadow-sm transition duration-300">
                                Afegir Serie
                            </button>
                        </div>
                        
                        <div id="sets-${exercise.id}" class="space-y-3">

                        </div>
                        
                        <div id="notes-${exercise.id}" class="mt-4 hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                            <textarea placeholder="Posa alguna nota de l'exercici si vols..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-gray-500 focus:border-gray-500"></textarea>
                        </div>
                        
                        <div class="mt-3 flex justify-end">
                            <button onclick="toggleNotes('${exercise.id}')" class="text-gray-600 hover:text-gray-800 text-sm font-medium">
                                <span id="notes-toggle-${exercise.id}">Afegir Notes</span>
                            </button>
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', exerciseHTML);
                addSet(exercise.id); 
            });
        }
        
        function addSet(exerciseId) {
            const setsContainer = document.getElementById(`sets-${exerciseId}`);
            const setId = `set-${exerciseId}-${Date.now()}`;
            
            const setHTML = `
                <div id="${setId}" class="flex items-center gap-3">
                    <div class="flex-1">
                        <label class="block text-xs font-medium text-gray-500 mb-1">Pes (kg)</label>
                        <input type="number" placeholder="0" class="w-full px-3 py-1 border border-gray-300 rounded-md focus:ring-gray-500 focus:border-gray-500">
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-medium text-gray-500 mb-1">Reps</label>
                        <input type="number" placeholder="0" class="w-full px-3 py-1 border border-gray-300 rounded-md focus:ring-gray-500 focus:border-gray-500">
                    </div>
                    <button onclick="removeSet('${setId}')" class="mt-5 text-red-500 hover:text-red-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            setsContainer.insertAdjacentHTML('beforeend', setHTML);
        }
        
        function removeSet(setId) {
            document.getElementById(setId).remove();
        }
        
        function toggleNotes(exerciseId) {
            const notesContainer = document.getElementById(`notes-${exerciseId}`);
            const toggleText = document.getElementById(`notes-toggle-${exerciseId}`);
            
            if (notesContainer.classList.contains('hidden')) {
                notesContainer.classList.remove('hidden');
                toggleText.textContent = 'Amagar Notes';
            } else {
                notesContainer.classList.add('hidden');
                toggleText.textContent = 'Afegir Notes';
            }
        }
        
        function saveWorkoutLog() {
            const routine = routines.find(r => r.id === currentRoutineId);
            if (!routine) return;
            
            const today = new Date().toISOString().split('T')[0];
            const workoutData = {
                date: new Date().toISOString(),
                exercises: []
            };
            
            routine.exercises.forEach(exercise => {
                const setsContainer = document.getElementById(`sets-${exercise.id}`);
                const sets = Array.from(setsContainer.children).map(setEl => {
                    const inputs = setEl.querySelectorAll('input');
                    return {
                        weight: inputs[0].value ? parseFloat(inputs[0].value) : null,
                        reps: inputs[1].value ? parseInt(inputs[1].value) : null
                    };
                }).filter(set => set.weight !== null && set.reps !== null);
                
                if (sets.length > 0) {
                    const notesContainer = document.getElementById(`notes-${exercise.id}`);
                    const notes = notesContainer.classList.contains('hidden') ? '' : notesContainer.querySelector('textarea').value.trim();
                    
                    workoutData.exercises.push({
                        exerciseId: exercise.id,
                        sets: sets,
                        notes: notes
                    });
                    
                    exercise.history.push({
                        date: new Date().toISOString(),
                        sets: sets,
                        notes: notes
                    });
                }
            });
            
            if (workoutData.exercises.length > 0) {
                routine.updatedAt = new Date().toISOString();
                localStorage.setItem('workoutRoutines', JSON.stringify(routines));
                alert('Entreno Registrat!');
                showRoutineDetail();
            } else {
                alert('No hi ha dades per a guardar. Logea un set com a minim per a guardar.');
            }
        }
        
        function logExercise(exerciseId) {
            const routine = routines.find(r => r.id === currentRoutineId);
            if (!routine) return;
            
            const exercise = routine.exercises.find(ex => ex.id === exerciseId);
            if (!exercise) return;
            
            document.getElementById('log-workout-title').textContent = `Resgistrar Entreno: ${routine.name}`;
            document.getElementById('log-workout-date').textContent = `Avui, ${formatDate(new Date().toISOString())}`;
            
            const container = document.getElementById('log-workout-container');
            container.innerHTML = '';
            
            const exerciseHTML = `
                <div class="bg-gray-50 rounded-lg border border-gray-200 p-4">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="font-medium text-gray-800">${exercise.name}</h4>
                            ${exercise.description ? `<p class="text-gray-600 text-sm mt-1">${exercise.description}</p>` : ''}
                        </div>
                        <button onclick="addSet('${exercise.id}')" class="bg-gray-600 hover:bg-gray-700 text-gray-100 text-sm font-semibold py-1 px-3 rounded-md shadow-sm transition duration-300">
                            Afegir Serie
                        </button>
                    </div>
                    
                    <div id="sets-${exercise.id}" class="space-y-3">

                    </div>
                    
                    <div id="notes-${exercise.id}" class="mt-4 hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                        <textarea placeholder="Posa alguna nota de l'exercici si vols..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-gray-500 focus:border-gray-500"></textarea>
                    </div>
                    
                    <div class="mt-3 flex justify-end">
                        <button onclick="toggleNotes('${exercise.id}')" class="text-gray-600 hover:text-gray-800 text-sm font-medium">
                            <span id="notes-toggle-${exercise.id}">Afegir Notes</span>
                        </button>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', exerciseHTML);
            addSet(exercise.id); 
            
            routineDetailScreen.classList.add('hidden');
            logWorkoutScreen.classList.remove('hidden');
        }
        
        function loadWorkoutHistory() {
            const routine = routines.find(r => r.id === currentRoutineId);
            if (!routine) return;
            
            document.getElementById('history-modal-title').textContent = `Diari d'Entreno: ${routine.name}`;
            const container = document.getElementById('workout-history-content');
            container.innerHTML = '';
            
            const allWorkouts = {};
            
            routine.exercises.forEach(exercise => {
                exercise.history.forEach(workout => {
                    const date = workout.date.split('T')[0];
                    if (!allWorkouts[date]) {
                        allWorkouts[date] = {
                            date: workout.date,
                            exercises: []
                        };
                    }

                    const existingExercise = allWorkouts[date].exercises.find(ex => ex.exerciseId === exercise.id);
                    if (!existingExercise) {
                        allWorkouts[date].exercises.push({
                            exerciseId: exercise.id,
                            name: exercise.name,
                            sets: workout.sets,
                            notes: workout.notes
                        });
                    }
                });
            });

            const sortedDates = Object.keys(allWorkouts).sort((a, b) => new Date(b) - new Date(a));
            
            if (sortedDates.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-history text-4xl text-gray-300 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-500">Encara no hi ha entrades al Diari</h3>
                        <p class="text-gray-400 mt-2">Logea el primer entreno!</p>
                    </div>
                `;
                return;
            }
            
            sortedDates.forEach(date => {
                const workout = allWorkouts[date];
                const workoutDate = new Date(workout.date);
                
                const workoutHTML = `
                    <div class="mb-6 border-b border-gray-200 pb-6 last:border-b-0 last:pb-0">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-semibold text-gray-800">${formatDate(workout.date)}</h4>
                            <span class="text-sm text-gray-500">${workoutDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                        </div>
                        
                        <div class="space-y-4">
                            ${workout.exercises.map(exercise => {
                                const exerciseData = routine.exercises.find(ex => ex.id === exercise.exerciseId);
                                return `
                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <div class="flex justify-between items-start mb-2">
                                            <h5 class="font-medium text-gray-800">${exerciseData.name}</h5>
                                        </div>
                                        
                                        <div class="space-y-2">
                                            ${exercise.sets.map((set, index) => `
                                                <div class="flex items-center gap-4 text-sm">
                                                    <span class="text-gray-500">Set ${index + 1}</span>
                                                    <span>${set.weight !== null ? set.weight + ' kg' : '-'}</span>
                                                    <span>×</span>
                                                    <span>${set.reps !== null ? set.reps : '-'}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                        
                                        ${exercise.notes ? `
                                            <div class="mt-2 pt-2 border-t border-gray-200">
                                                <p class="text-sm text-gray-600">${exercise.notes}</p>
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', workoutHTML);
            });
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }
        
        function deleteRoutine(routineId) {
            if (confirm('Segur que vols eliminar-ho? No ho podras recuperar.')) {
                routines = routines.filter(r => r.id !== routineId);
                localStorage.setItem('workoutRoutines', JSON.stringify(routines));
                loadRoutines();
            }
        }
        
        function deleteCurrentRoutine() {
            deleteRoutine(currentRoutineId);
            showMyRoutines();
        }
        
        function editCurrentRoutine() {
            const routine = routines.find(r => r.id === currentRoutineId);
            if (!routine) return;
            
            document.getElementById('routine-name').value = routine.name;
            document.getElementById('routine-description').value = routine.description || '';
            
            const exercisesContainer = document.getElementById('exercises-container');
            exercisesContainer.innerHTML = '';
            
            routine.exercises.forEach(exercise => {
                currentExerciseId++;
                const exerciseId = `exercise-${currentExerciseId}`;
                
                const exerciseHTML = `
                    <div id="${exerciseId}" class="exercise-item p-4 border border-gray-200 rounded-md bg-gray-50">
                        <div class="flex justify-between items-start mb-3">
                            <h4 class="font-medium text-gray-800">Exercise ${currentExerciseId}</h4>
                            <button onclick="removeExercise('${exerciseId}')" class="text-red-500 hover:text-red-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label for="${exerciseId}-name" class="block text-sm font-medium text-gray-700 mb-1">Nom de l'Exercici</label>
                                <input type="text" id="${exerciseId}-name" value="${exercise.name}" required class="w-full px-3 py-1 border border-gray-300 rounded-md focus:ring-gray-500 focus:border-gray-500">
                            </div>
                            <div>
                                <label for="${exerciseId}-description" class="block text-sm font-medium text-gray-700 mb-1">Description (Optional)</label>
                                <textarea id="${exerciseId}-description" rows="2" class="w-full px-3 py-1 border border-gray-300 rounded-md focus:ring-gray-500 focus:border-gray-500">${exercise.description || ''}</textarea>
                            </div>
                        </div>
                    </div>
                `;
                
                exercisesContainer.insertAdjacentHTML('beforeend', exerciseHTML);
                setupExerciseDragAndDrop(exerciseId);
            });
            
            routineDetailScreen.classList.add('hidden');
            createRoutineForm.classList.remove('hidden');
        }
        
        function setupExerciseDragAndDrop(exerciseId) {
            const element = document.getElementById(exerciseId);
            if (!element) return;
            
            element.draggable = true;
            
            element.addEventListener('dragstart', (e) => {
                element.classList.add('dragging');
                e.dataTransfer.setData('text/plain', exerciseId);
            });
            
            element.addEventListener('dragend', () => {
                element.classList.remove('dragging');
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const exercisesContainer = document.getElementById('exercises-container');
            if (exercisesContainer) {
                exercisesContainer.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const draggingElement = document.querySelector('.exercise-item.dragging');
                    if (!draggingElement) return;
                    
                    const afterElement = getDragAfterElement(exercisesContainer, e.clientY);
                    if (afterElement) {
                        exercisesContainer.insertBefore(draggingElement, afterElement);
                    } else {
                        exercisesContainer.appendChild(draggingElement);
                    }
                });
            }
        });
        
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.exercise-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        class Sortable {
            constructor(container, options) {
                this.container = container;
                this.options = options || {};
                this.draggedItem = null;
                
                this.container.querySelectorAll('.exercise-item').forEach(item => {
                    item.draggable = true;
                    item.addEventListener('dragstart', this.handleDragStart.bind(this));
                    item.addEventListener('dragend', this.handleDragEnd.bind(this));
                });
                
                this.container.addEventListener('dragover', this.handleDragOver.bind(this));
                this.container.addEventListener('dragenter', this.handleDragEnter.bind(this));
            }
            
            handleDragStart(e) {
                this.draggedItem = e.target;
                setTimeout(() => {
                    this.draggedItem.classList.add(this.options.ghostClass || 'dragging');
                }, 0);
            }
            
            handleDragEnd() {
                this.draggedItem.classList.remove(this.options.ghostClass || 'dragging');
                this.draggedItem = null;
                
                if (this.options.onEnd) {
                    this.options.onEnd();
                }
            }
            
            handleDragOver(e) {
                e.preventDefault();
                const afterElement = this.getDragAfterElement(e.clientY);
                if (afterElement) {
                    this.container.insertBefore(this.draggedItem, afterElement);
                } else {
                    this.container.appendChild(this.draggedItem);
                }
            }
            
            handleDragEnter(e) {
                e.preventDefault();
            }
            
            getDragAfterElement(y) {
                const draggableElements = [...this.container.querySelectorAll('.exercise-item:not(.dragging)')];
                
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }
        }
    </script>
</body>
</html>